# GROUPS

# remove unnecessary groups
- type: remove
  path: /groups

# RESOURCES

# repos
- type: replace
  path: /resources/name=stemcell-builder/source/branch
  value: ((DEV_BRANCH))

# versions
- type: replace
  path: /resources/name=azure-stemcell-version/source/initial_version
  value: 1200.5000.0
- type: replace
  path: /resources/name=vsphere-stemcell-version/source/initial_version
  value: 1200.5000.0
- type: replace
  path: /resources/name=stemcells-main-version/source/initial_version
  value: 1200.5000.0
- type: replace
  path: /resources/name=gcp-stemcell-version/source/initial_version
  value: 1200.5000.0
- type: replace
  path: /resources/name=updated-vmx-version/source/initial_version
  value: '30.0.0'

# remove unnecessary resources
- type: remove
  path: /resources/name=bosh-agent
- type: remove
  path: /resources/name=bwats
- type: remove
  path: /resources/name=stemcell-builder-develop
- type: remove
  path: /resources/name=stemcell-builder-release
- type: remove
  path: /resources/name=azure-lock
- type: remove
  path: /resources/name=major-stemcell
- type: remove
  path: /resources/name=vsphere-stemcell-final
- type: remove
  path: /resources/name=azure-stemcell-final
- type: remove
  path: /resources/name=gcp-stemcell-final
- type: remove
  path: /resources/name=aws-stemcell-final
- type: remove
  path: /resources/name=azure-stemcell-release-candidate
- type: remove
  path: /resources/name=azstemcell
- type: remove
  path: /resources/name=boshio

# JOBS

# configure create-vsphere-stemcell-from-diff for dev
- type: replace
  path: /jobs/name=create-vsphere-stemcell-from-diff/plan/task=create-stemcell/tags
  value: [diffcell-windows-worker-dev]
- type: replace
  path: /jobs/name=create-vsphere-stemcell-from-diff/plan/task=create-stemcell/params/VHD_VMDK_BUCKET
  value: all-bosh-windows-dev/2012R2/untested/vsphere/diffcell/inputs
- type: replace
  path: /jobs/name=create-vsphere-stemcell-from-diff/plan/task=create-stemcell/params/DIFF_OUTPUT_BUCKET
  value: all-bosh-windows-dev/2012R2/untested/vsphere/diffcell
- type: replace
  path: /jobs/name=create-vsphere-stemcell-from-diff/plan/task=create-stemcell/params/STEMCELL_OUTPUT_BUCKET
  value: all-bosh-windows-dev/2012R2/untested/vsphere/diffcell
- type: remove
  path: /jobs/name=create-vsphere-stemcell-from-diff/plan/0/aggregate/get=version/passed
- type: remove
  path: /jobs/name=create-vsphere-stemcell-from-diff/plan/0/aggregate/get=stemcell-builder/passed
- type: remove
  path: /jobs/name=create-vsphere-stemcell-from-diff/plan/0/aggregate/get=stemcells-main-version
- type: remove
  path: /jobs/name=test-vsphere-stemcell-from-diff/plan/0/aggregate/get=stemcells-main-version
- type: remove
  path: /jobs/name=create-vsphere-stemcell-from-diff/plan/0/aggregate/get=version/trigger

# configure build job
- type: remove
  path: /jobs/name=build-stemcells/plan/0/aggregate/get=stemcell-builder/passed
- type: remove
  path: /jobs/name=build-stemcells/plan/0/aggregate/get=updated-vmx-version/passed

# configure gcp for dev
- type: replace
  path: /jobs/name=create-gcp-stemcell/plan/1/do/task=create-stemcell/params/ACCOUNT_JSON
  value: ((MUSTANG-BOSH-WINDOWS-STEMCELLS_ACCOUNT_JSON))
- type: replace
  path: /jobs/name=create-gcp-stemcell/plan/1/do/task=create-stemcell/ensure/params/ACCOUNT_JSON
  value: ((MUSTANG-BOSH-WINDOWS-STEMCELLS_ACCOUNT_JSON))
- type: replace
  path: /jobs/name=create-gcp-stemcell/plan/1/do/put=gcp-2012R2-untested/params/file
  value: bosh-windows-stemcell/light-bosh-stemcell-*-google-kvm-windows2012R2-go_agent.tgz
- type: remove
  path: /jobs/name=create-gcp-stemcell/plan/1/do/task=publish-stemcell

- type: replace
  path: /jobs/name=create-vsphere-stemcell-from-vmx/plan/1/do/task=create-stemcell/tags
  value: [vsphere-windows-worker-dev]

# configure test-vsphere-stemcell-from-diff for dev
# no changes required

# configure azure for dev
- type: replace
  path: /jobs/name=create-azure-stemcell
  value:
    name: create-azure-stemcell
    serial: true
    plan:
    - do:
      - aggregate:
        - get: ci
        - get: sshd
          resource: openssh-release
          version: { tag: ((OPEN_SSH_VERSION)) }
        - get: stemcell-builder
        - get: stemcells-main-version
        - get: version
          resource: azure-stemcell-version
        - get: windows-stemcell-dependencies
      - put: version
        resource: azure-stemcell-version
        params:
          pre: build
      - task: create-stemcell
        file: ci/bosh-windows-stemcell-builder/create-azure-stemcell/task.yml
        params:
          ADMIN_PASSWORD: ((AZURE_STEMCELL_ADMIN_PASSWORD))
          BASE_IMAGE: ((AZURE_BASE_IMAGE_SKU))
          BASE_IMAGE_OFFER: ((AZURE_BASE_IMAGE_OFFER))
          CLIENT_ID: ((AZURE_CLIENT_ID))
          CLIENT_SECRET: ((AZURE_CLIENT_SECRET))
          LOCATION: 'Central US'
          OBJECT_ID: ((AZURE_OBJECT_ID))
          OFFER: 'bosh-windows-server'
          OS_VERSION: windows2012R2
          PUBLISHER: 'pivotal'
          RESOURCE_GROUP_NAME: ((AZURE_RESOURCE_GROUP))
          SKU: ((AZURE_OUTPUT_IMAGE_SKU))
          STORAGE_ACCOUNT: ((AZURE_STORAGE_ACCOUNT))
          SUBSCRIPTION_ID: ((AZURE_SUBSCRIPTION_ID))
          TENANT_ID: ((AZURE_TENANT_ID))
          VM_SIZE: Standard_DS2_v2
        ensure:
          task: delete-orphan-vms
          file: ci/delete-vms/task.yml
          params:
            CLIENT_ID: ((AZURE_CLIENT_ID))
            CLIENT_SECRET: ((AZURE_CLIENT_SECRET))
            SUBSCRIPTION_ID: ((AZURE_SUBSCRIPTION_ID))
            TENANT_ID: ((AZURE_TENANT_ID))
      - put: azure-stemcell-pre-release-candidate
        params:
          file: bosh-windows-stemcell/light-bosh-stemcell-*-azure-hyperv-windows2012R2-go_agent.tgz
      - put: azure-base-vhd-uri
        params:
          file: bosh-windows-stemcell/bosh-stemcell-*-azure-vhd-uri.txt

# remove unnecessary jobs
- type: remove
  path: /jobs/name=bump-stemcell-builder-submodules
- type: remove
  path: /jobs/name=test-stemcell-builder
- type: remove
  path: /jobs/name=promote-azure
- type: remove
  path: /jobs/name=promote-aws-gcp-vsphere
- type: remove
  path: /jobs/name=ship-bosh-stemcell-builder
- type: remove
  path: /jobs/name=create-vsphere-add-updates
- type: remove
  path: /jobs/name=print-azure-publishing-instructions
- type: remove
  path: /jobs/name=test-azure-stemcell
- type: remove
  path: /jobs/name=promote-boshio


# add bosh.io promote job
# - type: replace
#   path: /jobs/name=promote-boshio
#   value:
#     name: promote-boshio
#     serial: true
#     plan:
#     - aggregate:
#       - get: ci
#       - get: gcp
#         resource: gcp-stemcell-final
#       - get: azure
#         resource: azure-stemcell-final
#       - get: aws
#         resource: aws-stemcell-final
#       - get: version
#         resource: stemcells-main-version
#       - get: boshio-input
#         resource: boshio
#     - aggregate:
#       - task: commit-meta4-file
#         file: ci/bosh-windows-stemcell-builder/commit-meta4-file/task.yml
#         params:
#           OS_NAME: windows
#           OS_VERSION: 2012R2
#     # - put: boshio-output
#     #   params: {repository: boshio}
#     #   rebase: true
#     - put: stemcells-main-version
#       params:
#         bump: minor
